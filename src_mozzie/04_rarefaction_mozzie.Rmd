---
title: "Metabarcoding Rarefaction"
description: |
  A QIIME2-based metabarcoding workflow. Part 4.
author:
  - name: Melissa Carew
    url: https://example.com/
    affiliation: Example Organisation
    affiliation_url: https://example.com/
    orcid_id: 0000-0000-0000-0000
  - name: Jessica Chung
    url: https://github.com/jessicachung
    affiliation: Melbourne Bioinformatics, PEARG
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 4
    df_print: paged
    code_folding: true
    highlight: haddock
    highlight_downlit: false
    css: "custom.css"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=TRUE, message=TRUE, error=TRUE, echo=TRUE, results="hold")
knitr::opts_knit$set(root.dir = "..")
options(digits=4)
options(width=120)
```

```{r}
library(tidyverse)
library(dplyr)
library(vegan)
```

# rarefaction both amplicons
```{r}
# create directory to store results
dir.create(
  here::here("data_analysis/rarefaction_plots/"),
  recursive = TRUE,
  showWarnings = FALSE
)
# Read the CSV (note: escape the space in the filename)
metab_data_wide <- read.csv(
  "~/git/ten_site_metabarcoding/results/ten_site_data_summaries/ten_sites_vsearch_data_summary_filled_10_11_2025.csv"
)

# Select only asv_code and the desired columns
raref_data_wide <- metab_data_wide %>%
  select(asv_code, X10WMI2320rep1:X30DNG79574rep2)

# Remove non-numeric columns like ASV IDs if they exist
asv_mat <- raref_data_wide[, -1]  # assuming first column is ASV ID

# Ensure data are numeric
asv_mat <- as.data.frame(sapply(asv_mat, as.numeric))

sample_sums <- colSums(asv_mat)
summary(sample_sums)
hist(sample_sums, main = "Read depth per sample", xlab = "Number of reads")

rarefaction_depth <- 10000  # choose based on the histogram

# Rarefy each sample to the chosen depth
asv_rarefied <- rrarefy(t(asv_mat), sample = rarefaction_depth)
asv_rarefied <- t(asv_rarefied)

colSums(asv_rarefied)  # should all equal the rarefaction depth (or less if removed)

# Species richness (observed ASVs)
richness <- specnumber(t(asv_rarefied))

# Shannon diversity
shannon <- diversity(t(asv_rarefied), index = "shannon")

# Simpson diversity
simpson <- diversity(t(asv_rarefied), index = "simpson")

alpha_div <- data.frame(
  Sample = names(richness),
  Richness = richness,
  Shannon = shannon,
  Simpson = simpson
)
alpha_div

# Disable scientific notation
options(scipen = 999)

# Compute x-axis range
x_range <- range(rowSums(t(asv_mat)))

plot.new()  # start fresh plot window
par(mfrow = c(1,1))  # reset layout

# Plot rarefaction curves (no labels, minimal borders)
rarecurve(
  t(asv_mat),
  step = 500,
  sample = rarefaction_depth,
  col = "steelblue",
  label = FALSE,
  cex = 0.1,
  ylab = "ASVs",
  xlab = "Sequencing depth",
  lwd = 2,
  las = 0.2,
  bty = "l",      # left and bottom borders only
  axes = FALSE
)

# Add clean custom axes with non-scientific numbers
axis(1, at = pretty(x_range), labels = pretty(x_range), lwd.ticks = 0.8)
axis(2, las = 1, lwd.ticks = 0.8)

# Add box outline for left and bottom only
box(bty = "l")

# Add red dashed line at the rarefaction depth
abline(v = rarefaction_depth, col = "red", lty = 2)



```
# saved version rarefaction both amplicons
```{r}
 # Open PNG device
png("~/git/ten_site_metabarcoding/data_analysis/rarefaction_plots/rarefaction_plot_both_amplicons_reps.png", width = 2000, height = 1500, res = 300)  # high-res

# Calculate rarefaction curves without plotting
rc <- rarecurve(t(asv_mat), step = 500, sample = rarefaction_depth, label = FALSE, plot = FALSE)

# Convert to a matrix for plotting
max_length <- max(sapply(rc, length))
rc_mat <- sapply(rc, function(x) {
  c(x, rep(NA, max_length - length(x)))
})

# Create x-axis values (sequencing depth)
x_vals <- seq(from = 0, by = 500, length.out = max_length)  # step = 500

# Plot manually with correct x-axis scale
matplot(
  x_vals,
  rc_mat,
  type = "l",
  lty = 1,
  col = "steelblue",
  lwd = 2,
  xlab = "Sequencing depth",
  ylab = "ASVs",
  axes = FALSE,
  frame.plot = FALSE,
  bg = "white"
)

# Add axes manually with black tick labels
axis(1, col = "black", col.axis = "black", lwd = 2)
axis(2, col = "black", col.axis = "black", lwd = 2)
box(lwd = 2, col = "black")  # optional border

dev.off()
```

# rarefaction short amplicon
```{r}
# Filter only short amplicon rows
metab_data_wide_s <- metab_data_wide %>%
  filter(amplicon == "short")

# Select only asv_code and sample columns
raref_data_wide_s <- metab_data_wide_s %>%
  select(asv_code, X10WMI2320rep1:X30DNG79574rep2)

# Remove non-numeric columns like ASV IDs
asv_mat_s <- raref_data_wide_s[, -1]  # first column is ASV ID

# Ensure numeric
asv_mat_s <- as.data.frame(sapply(asv_mat_s, as.numeric))

# Check read depths
sample_sums_s <- colSums(asv_mat_s)
summary(sample_sums_s)
hist(sample_sums_s, main = "Read depth per sample", xlab = "Number of reads")

# Set rarefaction depth
rarefaction_depth <- 20000  

# Rarefy
asv_rarefied_s <- rrarefy(t(asv_mat_s), sample = rarefaction_depth)
asv_rarefied_s <- t(asv_rarefied)

colSums(asv_rarefied)  # check all equal or less than rarefaction depth

# Alpha diversity metrics
richness_s <- specnumber(t(asv_rarefied_s))
shannon_s <- diversity(t(asv_rarefied_s), index = "shannon")
simpson_s <- diversity(t(asv_rarefied_s), index = "simpson")

alpha_div_s <- data.frame(
  Sample = names(richness),
  Richness = richness,
  Shannon = shannon,
  Simpson = simpson
)

alpha_div

# Plot rarefaction curves
options(scipen = 999)
x_range <- range(rowSums(t(asv_mat_s)))

plot.new()
par(mfrow = c(1,1))

rarecurve(
  t(asv_mat_s),
  step = 500,
  sample = rarefaction_depth,
  col = "steelblue",
  label = FALSE,
  cex = 0.1,
  ylab = "ASVs",
  xlab = "Sequencing depth",
  lwd = 2,
  las = 0.2,
  bty = "l",
  axes = FALSE
)

axis(1, at = pretty(x_range), labels = pretty(x_range), lwd.ticks = 0.8)
axis(2, las = 1, lwd.ticks = 0.8)
box(bty = "l")
abline(v = rarefaction_depth, col = "red", lty = 2)
```

# saved version rarefaction short amplicon
```{r}
# Open PNG device
png("~/git/ten_site_metabarcoding/data_analysis/rarefaction_plots/rarefaction_plot_short_amplicon_reps.png", width = 2000, height = 1500, res = 300)  # high-res

# Calculate rarefaction curves without plotting
rc <- rarecurve(t(asv_mat_s), step = 500, sample = rarefaction_depth, label = FALSE, plot = FALSE)

# Convert to a matrix for plotting
max_length <- max(sapply(rc, length))
rc_mat <- sapply(rc, function(x) {
  c(x, rep(NA, max_length - length(x)))
})

# Create x-axis values (sequencing depth)
x_vals <- seq(from = 0, by = 500, length.out = max_length)  # step = 500

# Plot manually with correct x-axis scale
matplot(
  x_vals,
  rc_mat,
  type = "l",
  lty = 1,
  col = "steelblue",
  lwd = 2,
  xlab = "Sequencing depth",
  ylab = "ASVs",
  axes = FALSE,
  frame.plot = FALSE,
  bg = "white"
)

# Add axes manually with black tick labels
axis(1, col = "black", col.axis = "black", lwd = 2)
axis(2, col = "black", col.axis = "black", lwd = 2)
box(lwd = 2, col = "black")  # optional border

dev.off()
```

# rarefaction right amplicon
```{r}
# Filter only short amplicon rows
metab_data_wide_r <- metab_data_wide %>%
  filter(amplicon == "right")

# Select only asv_code and sample columns
raref_data_wide_r <- metab_data_wide_r %>%
  select(asv_code, X10WMI2320rep1:X30DNG79574rep2)

# Remove non-numeric columns like ASV IDs
asv_mat_r <- raref_data_wide_r[, -1]  # first column is ASV ID

# Ensure numeric
asv_mat_r <- as.data.frame(sapply(asv_mat_r, as.numeric))

# Check read depths
sample_sums_r <- colSums(asv_mat_r)
summary(sample_sums_r)
hist(sample_sums_r, main = "Read depth per sample", xlab = "Number of reads")

# Set rarefaction depth
rarefaction_depth <- 5000  

# Rarefy
asv_rarefied_r <- rrarefy(t(asv_mat_r), sample = rarefaction_depth)
asv_rarefied_r <- t(asv_rarefied)

colSums(asv_rarefied)  # check all equal or less than rarefaction depth

# Alpha diversity metrics
richness_r <- specnumber(t(asv_rarefied_r))
shannon_r <- diversity(t(asv_rarefied_r), index = "shannon")
simpson_r <- diversity(t(asv_rarefied_r), index = "simpson")

alpha_div_r <- data.frame(
  Sample = names(richness),
  Richness = richness,
  Shannon = shannon,
  Simpson = simpson
)

alpha_div

# Plot rarefaction curves
options(scipen = 999)
x_range <- range(rowSums(t(asv_mat_r)))

plot.new()
par(mfrow = c(1,1))

rarecurve(
  t(asv_mat_r),
  step = 500,
  sample = rarefaction_depth,
  col = "steelblue",
  label = FALSE,
  cex = 0.1,
  ylab = "ASVs",
  xlab = "Sequencing depth",
  lwd = 2,
  las = 0.2,
  bty = "l",
  axes = FALSE
)

axis(1, at = pretty(x_range), labels = pretty(x_range), lwd.ticks = 0.8)
axis(2, las = 1, lwd.ticks = 0.8)
box(bty = "l")
abline(v = rarefaction_depth, col = "red", lty = 2)
```

# saved version rarefaction right amplicon
```{r}
# Open PNG device
png("~/git/ten_site_metabarcoding/data_analysis/rarefaction_plots/rarefaction_plot_right_amplicon_reps.png", width = 2000, height = 1500, res = 300)  # high-res

# Calculate rarefaction curves without plotting
rc <- rarecurve(t(asv_mat_r), step = 500, sample = rarefaction_depth, label = FALSE, plot = FALSE)

# Convert to a matrix for plotting
max_length <- max(sapply(rc, length))
rc_mat <- sapply(rc, function(x) {
  c(x, rep(NA, max_length - length(x)))
})

# Create x-axis values (sequencing depth)
x_vals <- seq(from = 0, by = 500, length.out = max_length)  # step = 500

# Plot manually with correct x-axis scale
matplot(
  x_vals,
  rc_mat,
  type = "l",
  lty = 1,
  col = "steelblue",
  lwd = 2,
  xlab = "Sequencing depth",
  ylab = "ASVs",
  axes = FALSE,
  frame.plot = FALSE,
  bg = "white"
)

# Add axes manually with black tick labels
axis(1, col = "black", col.axis = "black", lwd = 2)
axis(2, col = "black", col.axis = "black", lwd = 2)
box(lwd = 2, col = "black")  # optional border

dev.off()
```














