---
title: "macroinvertebrates_morph_comparisions"
author: "Melissa Carew"
date: "11/11/2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r supress warning}
# load libraries
library(tidyverse)
library(vegan)
library(compositions)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(patchwork)
library(here)
```

```{r}
# add taxoncodes to dna data
fambc <- read.csv(here::here("data/family_bugcodes.csv")) # macroinvertebrate taxoncodes

# read in DNA data and align with full data labels (add back in hyphens)
metab_filt <- read.csv(here::here("results/ten_site_data_summaries/ten_sites_final_long_format_04_12_2025.csv")) %>%
  mutate(
    site = case_when(
      site == "FEH41843"  ~ "FEH-4184-3",
      site == "YAR36377"  ~ "YAR-3637-7",
      site == "BNY29042"  ~ "BNY-2904-2",
      site == "UYT1993"   ~ "UYT-199-3",
      site == "WMI2320"   ~ "WMI-232-0",
      site == "FER6475"   ~ "FER-647-5",
      site == "GRD75620"  ~ "GRD-7562-0",
      site == "TOO42700"  ~ "TOO-4270-0",
      site == "DNG318813" ~ "DNG-31881-3",
      site == "DNG79574"  ~ "DNG-7957-4",
      TRUE ~ site  # keep all others unchanged
    )
  )

metab_filt <- metab_filt %>%
  left_join(fambc %>% select(family, shortcode), 
            by = "family", 
            relationship = "many-to-one") %>%
  mutate(
    # replace NAs from join with empty cells
    shortcode = coalesce(shortcode, ""),
    
    # enforce Eiseniella tetraedra rule
    shortcode = if_else(species == "Eiseniella tetraedra", "LO09", shortcode)
  )

# move data with bug codes into a new df
metab_filt_macro <- metab_filt %>%
  filter(shortcode != "" & !is.na(shortcode))


timestamp <- format(Sys.time(), "%d_%m_%Y")

# Create the file name with the timestamp (NOTE:Change the MiSeq number to the dataset you are working with)
file_name <- here::here(
  paste0("results/ten_site_data_summaries/ten_sites_wide_format_", timestamp, ".csv"))

# truncate code to bioassessment levels for taxa not identified to family
metab_filt_macro_bio <- metab_filt_macro %>%
   mutate(shortcode = case_when(
    str_starts(shortcode, "MO") ~ "MM",
    str_starts(shortcode, "MP") ~ "MM",
    str_starts(shortcode, "LO") ~ "LO",
    TRUE ~ shortcode
  ))

no_bc <- metab_filt %>%
  anti_join(metab_filt_macro, by = "shortcode") #

# Create output directory if needed
dir.create(
  here::here("results/data_analysis/macro_data"),
  recursive = TRUE,
  showWarnings = FALSE
)

write.csv(metab_filt_macro, here::here("results/data_analysis/macro_data/ten_site_metaber_macro.csv"))
```

# How many sequences and ASVs were assigned to species in the final dataset
```{r}
# total number of ASVs
num_asv <- length(unique(metab_filt_macro$asv_code))

# short amplicon (BF1/BR1) ASV's 
short_asv <- metab_filt_macro[metab_filt_macro$amplicon == "short", ]
uni_short <- length(unique(short_asv$asv_code))
short_asv_reads <- sum(short_asv$reads)

#right amplicon (mICOIintF/dgHCO2198) ASV's 
right_asv <- metab_filt_macro[metab_filt_macro$amplicon == "right", ]
uni_right <- length(unique(right_asv$asv_code))
right_asv_reads <- sum(right_asv$reads)

# total number of ASVs with species identifications
marcos_97 <- subset(metab_filt_macro, max_p_identity >= 97)
num_asv_sp <- length(unique(marcos_97$asv_code))

# calculate the percentage of ASVs with species ids
percentage_asv_id <- num_asv_sp / num_asv *100

# total number of high quality reads
total_reads <- sum(metab_filt_macro$reads)

# total number of high quality reads with species identifications
sp_reads <- sum(marcos_97$reads)

# calculate the percentage of reads with species identifications
percentage_sp_ids <- sp_reads/ total_reads *100

# how many species/families
sp_count <- length(unique(marcos_97$species))
fam_count <- length(unique(marcos_97$family))

# print stats
print(paste("total_marcoinvertebrate_reads_used in_analysis =", total_reads))
print(paste("Total_no_of__marcoinvertebrate_ASVs =",num_asv))
print(paste("Total_no_of_marcoinvertebrate_ASVs_short amplicon_(B/R5)  =", uni_short))
print(paste("Total_no_of_marcoinvertebrate_reads_short amplicon_(B/R5)  =", short_asv_reads))
print(paste("Total_no_of_marcoinvertebrate_ASVs_right amplicon_(mICOIintF/dgHCO2198)  =", uni_right))
print(paste("Total_no_of_marcoinvertebrate_reads_right amplicon_(mICOIintF/dgHCO2198)  =", right_asv_reads))
print(paste("marcoinvertebrate percentage_asv_id_to_species =", percentage_asv_id))
print(paste("percentage of marcoinvertebrate reads with species identifications", percentage_sp_ids))
print(paste("no. of marcoinvertebrate species = ", sp_count))
print(paste("no. of marcoinvertebrate familes = ", fam_count))
```

```{r}
# load site and dry weight data
site_dw <- read.csv(here::here("data/ten_site_dry_weight.csv"))

# Load morphological data files
morph50 <- read.csv(here::here("data/ten_site_50ml_morph_data.csv"))
morph_larg <- read.csv(here::here("data/ten_site_large_frac_data.csv"))

# summarize number of families in 50mls
morph50_nfam <- morph50 %>%
  group_by(site) %>%
  summarise(nfam_50ml = n_distinct(shortcode))

# summarize abundance of families in 50mls
morph50_abund <- morph50 %>%
  group_by(site) %>%
  summarise(abundance_50ml = sum(count, na.rm = TRUE))

# summarise number of families in large fraction
morph_larg_nfam <- morph_larg %>%
  group_by(site) %>%
  summarise(nfam_larfrac = n_distinct(shortcode))

# summarise abundance in large fraction  
morph_larg_abund <- morph_larg %>% 
  group_by(site) %>%
  summarise(abundance_larfrac = sum(count, na.rm = TRUE))

# --- combine all summaries ---
morph_sum <- morph50_nfam %>%
  full_join(morph50_abund, by = "site") %>%
  full_join(morph_larg_nfam, by = "site") %>%
  full_join(morph_larg_abund, by = "site") %>%
  left_join(
    site_dw %>% select(site, rich_class, abund_class),
    by = "site"
  ) %>%
  select(
    site, rich_class, abund_class,
    nfam_50ml, abundance_50ml,
    nfam_larfrac, abundance_larfrac
  )

# Create output directory if needed
dir.create(
  here::here("results/data_analysis/morph_table"),
  recursive = TRUE,
  showWarnings = FALSE
)

write.csv(morph_sum, here::here("results/data_analysis/morph_table/ten_site_morph_summary.csv"))
```

```{r}
missing_pairs_morph50 <- morph50 %>%
  filter(!is.na(shortcode), shortcode != "") %>%
  select(site, shortcode, family) %>%
  distinct() %>%   # <-- removes exact duplicates
  anti_join(
    metab_filt_macro_bio %>%
      select(site, shortcode) %>%
      distinct(),
    by = c("site", "shortcode")
  ) %>%
  arrange(site, shortcode)

missing_pairs_morph50
```

```{r}
missing_pairs_morph_larg <- morph_larg %>%
  filter(!is.na(shortcode), shortcode != "") %>%  # ignore blank or missing shortcodes
  select(site, shortcode, family) %>%
  anti_join(
    metab_filt_macro_bio %>%
      select(site, shortcode) %>%
      distinct(),
    by = c("site", "shortcode")
  ) %>%
  arrange(site, shortcode)

missing_pairs_morph_larg
```
```{r}
# Step 1: Identify species only in per = 10 per site
species_only_10_per_site <- metab_filt_macro %>%
  group_by(site, species) %>%
  summarize(per_values = list(unique(per)), .groups = "drop") %>%
  filter(sapply(per_values, function(x) length(x) == 1 && x == 10)) %>%
  select(site, species)

# Step 2: Add shortcode information
species_only_10_shortcodes <- species_only_10_per_site %>%
  left_join(metab_filt_macro %>% select(species, shortcode) %>% distinct(),
            by = "species")

# Step 3: Check if the shortcode is present in morph_larg at the same site
species_only_10_shortcodes <- species_only_10_shortcodes %>%
  rowwise() %>%
  mutate(shortcode_in_morph = shortcode %in% morph_larg$shortcode[morph_larg$site == site]) %>%
  ungroup()

species_only_10_shortcodes
```

Classify all taxa found in run into common name groups for pie charts
```{r}
# assigning common group names

no_bc <- no_bc %>%
  mutate(group = case_when(
    # Terrestrial invertebrates
    order %in% c("Hymenoptera", "Araneae", "Sarcoptiformes", "Pseudoscorpiones", "Mesostigmata") ~ "terrestrial invertebrate",
    class %in% c("Collembola", "Diplopoda", "Chilopoda", "Symphyla") ~ "terrestrial invertebrate",
    phylum %in% c("Mollusca") ~ "terrestrial invertebrate",
    class == "Insecta" & !is.na(species) & species != "" ~ "terrestrial invertebrate",
    family %in% c("Ocnerodrilidae", "Bdellidae", "Lumbricidae") ~ "terrestrial invertebrate",
    
    # Freshwater microinvertebrates
    class %in% c("Branchiopoda", "Ostracoda", "Hexanauplia", "Gymnolaemata", "Copepoda") ~ "freshwater microinvertebrate",
    phylum %in% c("Tardigrada", "Bryozoa","Tubulinea", "Gastrotricha") ~ "freshwater microinvertebrate",
    
    # Fungi
    phylum %in% c("Ascomycota", "Mucoromycota", "Heterokontophyta", "Basidiomycota", "Oomycota") ~ "fungi",

    # Fish
    phylum == "Chordata" ~ "fish",
    
    # Amoeba / Zooplankton / Rotifers
    phylum %in% c("Rotifera", "Amoebozoa", "Evosea","Discosea") ~ "amoeba/rotifers/zooplankton",
    species == "uncultured zooplankton" ~ "amoeba/rotifers/zooplankton",
    
    # Algae / Plants
    phylum %in% c("Rhodophyta", "Ochrophyta", "Bacillariophyta", "Chlorophyta", "Streptophyta", "Cryptista",  "Gyrista", "Magnoliophyta") | class == "Phaeophyceae" ~ "algae/plants",
    
    # Unassigned
    kingdom == "Unassigned" ~ "unassigned",
    kingdom == "Eukaryota" & (is.na(phylum) | phylum == "") & (is.na(class) | class == "") ~ "unassigned",
    
    # Invertebrates (unknown origin)
    phylum %in% c("Platyhelminthes", "Nemertea", "Nematoda", "Cnidaria", "Porifera", "Polychaeta", "invertebrate environmental sample") ~ "invertebrates (unknown origin)",
    class == "Malacostraca" ~ "invertebrates (unknown origin)",
    phylum == "Annelida" & (is.na(species) | species == "") ~ "invertebrates (unknown origin)",
    class %in% c("Insecta", "Trombidiformes") & (is.na(species) | species == "") ~ "invertebrates (unknown origin)",
    species %in% c("Enchytraeida sp. MC-2", "Haplotaxida sp. MC-1") ~ "invertebrates (unknown origin)",
    phylum == "Arthropoda" & (!is.na(class) & class == "") ~ "invertebrates (unknown origin)",
    class == "Arachnida" & (is.na(order) | order == "") ~ "invertebrates (unknown origin)",
    order == "Trombidiformes" & (is.na(family) | family == "") ~ "invertebrates (unknown origin)",
    
    # Bacteria
    kingdom == "Prokaryota" ~ "bacteria",
    
    # Fallback
    TRUE ~ NA_character_
  ))

metab_filt_macro <- metab_filt_macro %>%
  mutate(group = "freshwater macroinvertebrates")

metab_filt_grps <- rbind(metab_filt_macro, no_bc) %>%
  select(group, asv_code, reads) %>%
  group_by(asv_code, group) %>%       # group by ASV and group
  summarise(reads = sum(reads, na.rm = TRUE), .groups = "drop")  # sum reads per ASV/group

# Summarise by group
asv_reads_grp_sum<- metab_filt_grps %>%
  group_by(group) %>%
  summarise(
    n_asv = n_distinct(asv_code),   # count unique ASVs
    total_reads = sum(reads, na.rm = TRUE),  # sum reads
    .groups = "drop"
  )

# View the summary
asv_reads_grp_sum

# Create output directory if needed
dir.create(
  here::here("results/data_analysis/pie_charts"),
  recursive = TRUE,
  showWarnings = FALSE
)

write.csv(
  asv_reads_grp_sum,
  here::here("results/data_analysis/pie_charts/asv_reads_grp_sum.csv"),
  row.names = FALSE
)
```
# compare abundance to dry wieght
```{r}
abund_dw <- morph_sum %>%
  left_join(site_dw %>% select(site, t_dw), by = "site")

cor.test(abund_dw$abundance_50ml, abund_dw$t_dw, method = "pearson")

# # Your data

# -----------------------------
# 1. Abundance class vs dry weight
# -----------------------------
ggplot(abund_dw, aes(x = abund_class, y = t_dw, fill = abund_class)) +
  geom_boxplot(alpha = 0.6) +
  geom_jitter(width = 0.1) +
  theme_minimal() +
  labs(title = "Dry Weight by Abundance Class")


# -----------------------------
# 2. Abundance vs dry weight
# -----------------------------
ggplot(abund_dw, aes(x = abund_class, y = t_dw)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal() +
  labs(title = "Abundance vs Dry Weight")


# -----------------------------
# 3. Dry weight vs richness (numeric)
# -----------------------------
ggplot(abund_dw, aes(x = rich_class, y = t_dw, fill = rich_class)) +
  geom_boxplot(alpha = 0.6) +
  geom_jitter(width = 0.1) +
  theme_minimal() +
  labs(title = "Dry Weight by Richness Class")

t.test(t_dw ~ abund_class, data = abund_dw, var.equal = FALSE)

```
`

```{r}
metab_filt_macro_fam_count <- metab_filt_macro %>%
  group_by(site) %>%
  summarise(shortcode_count = n_distinct(shortcode))

metab_filt_macro_sp_count <- metab_filt_macro %>%
  group_by(site) %>%
  summarise(species = n_distinct(species))

metab_filt_macro_summary <- metab_filt_macro %>%
  group_by(site) %>%
  summarise(
    shortcode_count = n_distinct(shortcode),
    species_count = n_distinct(species)
  )

metab_filt_macro_summary

write.csv(metab_filt_macro_summary, here::here("results/data_analysis/macro_data/metab_filt_macro_summary.csv"))

# Example: if your df is named metab_filt_macro_summary
# with columns: site, species_count, shortcode_count
# rename 'shortcode_count' to 'families' for clarity
metab_filt_macro_summary <- metab_filt_macro_summary %>%
  rename(families = shortcode_count, species = species_count)

# Pivot to long format for ggplot
plot_data <- metab_filt_macro_summary %>%
  pivot_longer(cols = c(species, families),
               names_to = "taxa_type",
               values_to = "count")

# Plot
ggplot(plot_data, aes(x = site, y = count, fill = taxa_type)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(aes(label = count),
            position = position_dodge(width = 0.8),
            vjust = -0.3, size = 3.5) +
  scale_fill_manual(values = c("species" = "#4472C4", "families" = "#ED7D31")) +
  labs(x = "Site",
       y = "no. of taxa",
       fill = NULL) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    panel.grid = element_blank(),
    legend.position = "top"
  )

## test for significance

species_family <- plot_data %>%
  select(site, taxa_type, count) %>%
  pivot_wider(
    names_from = taxa_type,
    values_from = count
  )   # gives columns: species, families

rich_abun <- site_dw %>%
  left_join(species_family, by = "site") %>%
  select(site, rich_class, abund_class, species, families)

# t-tests
print(t.test(families ~ rich_class, data = rich_abun))
print(t.test(families ~ abund_class, data = rich_abun))

print(t.test(species ~ rich_class, data = rich_abun))
print(t.test(species ~ abund_class, data = rich_abun))


```

Box plots of the proportion of species found in each subsample

```{r}
# filter to >=97% identity
metab_filt_macro97 <- metab_filt_macro %>% 
  filter(max_p_identity >= 97)

# Step A: species richness per site Ã— per (what you already had)
site_per_totals <- metab_filt_macro97 %>%
  group_by(site, per) %>%
  summarise(
    total_species = n_distinct(species),
    .groups = "drop"
  )

# Step B: total species per site across all periods (site-level total)
site_totals <- metab_filt_macro97 %>%
  group_by(site) %>%
  summarise(
    site_total_species = n_distinct(species),
    .groups = "drop"
  )

# Step C: join and compute the desired proportion
site_sample_prop <- site_per_totals %>%
  left_join(site_totals, by = "site") %>%
  mutate(
    species_prop = total_species / site_total_species
  )

# Inspect
print(site_sample_prop)

# ---- Example plot: show distribution of species_prop across periods ----
p <- ggplot(site_sample_prop, aes(x = factor(per), y = species_prop)) +
  geom_boxplot(
    fill = "lightblue",
    color = "black",
    width = 0.6,
    #outlier.shape = 19,       # solid black dot
    #outlier.size = 2.5,       # make outlier a bit larger
    #outlier.color = "black"
  ) +
  stat_summary(
    fun = mean,
    geom = "point",
    shape = 18,
    size = 4,
    color = "black"
  ) +
  labs(
    x = "percentage of sample processed",
    y = "proportion of species of total detected",
  ) +
  theme_classic(base_size = 14) +   # Start with a clean theme with borders
  theme(
    panel.background = element_rect(fill = "white", color = "black"),  # white background, black border
    plot.background = element_rect(fill = "white"),                     # background outside panel
    plot.title = element_text(hjust = 0.5))


# save as PNG
ggsave(
  filename = here::here("results/data_analysis/macro_data/species_proportion_plot.png"),
  plot = p,
  width = 8,      # inches
  height = 6,     # inches
  dpi = 300       # high resolution
)

print(p)

anova_prop <- aov(species_prop ~ factor(per), data = site_sample_prop)
summary(anova_prop)
```

Community structure across subsamples
```{r}
# Step 1: build site_sample Ã— species matrix
comm_matrix <- metab_filt_macro97 %>%
  group_by(site, per, species) %>%
  summarise(abundance = sum(reads), .groups = "drop") %>%
  pivot_wider(names_from = species, values_from = abundance, values_fill = 0)

# Step 2: species matrix only
species_mat <- comm_matrix %>%
  select(-site, -per) %>%
  as.data.frame()

# Step 3: metadata
meta <- comm_matrix %>%
  select(site, per)

# Step 4: CLR transform (pseudocount to avoid log(0))
species_mat_clr <- clr(species_mat + 1) %>%
  as.data.frame()

# Step 5: run ordination (Euclidean distance after CLR = Aitchison distance)
mds <- metaMDS(species_mat_clr, distance = "euclidean", k = 2, trymax = 100)

# Step 6: extract scores
mds_scores <- as.data.frame(scores(mds, display = "sites"))
mds_scores <- cbind(meta, mds_scores)

# Step 7: plot with stress in title
stress_val <- round(mds$stress, 3)

n <- ggplot(mds_scores, aes(x = NMDS1, y = NMDS2, color = site, shape = as.factor(per))) +
  geom_point(size = 4, alpha = 0.9) +
  theme_minimal(base_size = 14) +
  scale_color_brewer(palette = "Paired") +  # nice distinct colors for 10 sites
  labs(
    title = paste0("Stress = ", stress_val),
    x = "NMDS1",
    y = "NMDS2",
    color = "site",
    shape = "sample percentage "
  ) +
  theme(
    legend.position = "right",
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
     panel.border = element_rect(color = "black", fill = NA, linewidth = 1)  # ðŸ”² adds black border
  )

# save as PNG
ggsave(
  filename = here::here("results/adta_analysis/macro_data/nmds_precentage_plot.png"),
  plot = n,
  width = 8,      # inches
  height = 6,     # inches
  dpi = 300       # high resolution
)
print(n)
```
```{r}

plot_df <- site_samp_prop_dw

# PANEL A
p1 <- ggplot(plot_df, aes(x = subsamp_prpn, y = sp_richness, color = site)) +
  geom_line(aes(group = site), linewidth = 0.6, alpha = 0.8) +
  geom_point(size = 2, alpha = 0.9) +          # â† no jitter
  scale_color_brewer(palette = "Paired") +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_y_continuous(limits = c(0, NA)) +
  labs(
    x = "sub-sample",
    y = "species richness"
  ) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "none",
    panel.border = element_rect(color = "black", fill = NA),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank()
  )

# PANEL B
p2 <- ggplot(plot_df, aes(x = subsamp_dw, y = sp_richness, color = site)) +
  geom_line(aes(group = site), linewidth = 0.6, alpha = 0.8) +
  geom_jitter(width = 0.15, height = 0.15, size = 2, alpha = 0.9) +
  scale_color_brewer(palette = "Paired") +
  scale_y_continuous(limits = c(0, NA)) +
  labs(x = "dry weight (g)", y = "species richness", color = "site") +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "right",
    panel.border = element_rect(color = "black", fill = NA),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank()
  )


# Combine
(p1 | p2)

combined_plot <- (p1 | p2)

ggsave(here::here("results/adta_analysis/macro_data/species_richness_panels.png"), 
       plot = combined_plot,
       width = 10, height = 4, dpi = 300)
```

```{r}
df_species_dw <- site_sample_prop_filt %>%
  left_join(site_dw %>% select(site, t_dw), by = "site") %>%  # join only site and t_dw
  mutate(dw = (per / 100) * t_dw) %>%                          # calculate proportional dw
  select(-t_dw)     
```




