---
title: "01_miseq_run_statistics"
author: "Melissa Carew"
date: "09/11/2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
title: "raw_metabarcoding_data_stats calculations"
author: "Melissa Carew"
date: "2023-12-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(dplyr)
library(vegan)
library(here)
```

```{r}
# input unflitered metabarcoding data with final taxonomy
metab_fil <- read.csv(here::here("results/ten_site_data_summaries/ten_sites_vsearch_data_summary_filled_long_format_20_11_2025.csv"))

# input  finL flitered metabarcoding data     
metab_filt <- read.csv(here::here("results/ten_site_data_summaries/ten_sites_final_long_format_20_11_2025.csv"))
```


# MACROINVERTEBRATE SAMPLE DNA METABARCODING
 
# Format metabarcoding data for stats analysis
 
# reads per sample per replicate
```{r}
# Create table of reads for each PCR replicate for each sample (unfiltered)
metab_fil_reads <- metab_fil %>%
  dplyr::group_by(site, per, replicate) %>%   # include site here
  summarise(reads = sum(reads), .groups = "drop")

metab_fil_reads_tab <- tidyr::spread(metab_fil_reads, key = replicate, value = reads)

# Create table of reads for each PCR replicate for each sample (filtered)
metab_filt_reads <- metab_filt %>%
  dplyr::group_by(site, per, replicate) %>%   # include site here too
  summarise(reads = sum(reads), .groups = "drop")

metab_filt_reads_tab <- tidyr::spread(metab_filt_reads, key = replicate, value = reads)

# Add total reads
metab_fil_reads_tab <- metab_fil_reads_tab %>%
  mutate(total = rep1 + rep2)

metab_filt_reads_tab <- metab_filt_reads_tab %>%
  mutate(total = rep1 + rep2)

# Report minimums
lowest_total_reads <- min(metab_fil_reads_tab$total, na.rm = TRUE)
lowest_rep_reads <- pmin(metab_fil_reads_tab$rep1, metab_fil_reads_tab$rep2, na.rm = TRUE)
overall_lowest_rep_reads <- min(lowest_rep_reads, na.rm = TRUE)

# Rename columns for the final supplementary table
metab_fil_reads_tab <- metab_fil_reads_tab %>%
  rename(
    `PCR replicate 1` = rep1,
    `PCR replicate 2` = rep2
  )

# Create output directory if needed
dir.create(
  here::here("data_analysis/run_stats"),
  recursive = TRUE,
  showWarnings = FALSE
)

# Write Excel file
writexl::write_xlsx(
  metab_fil_reads_tab,
  path = here::here("data_analysis/run_stats/DNA_metabarcoding_reads_summary.xlsx")
)

total_reads_overall_fil <- sum(metab_fil_reads_tab$total, na.rm = TRUE)
print(paste("total_reads_overall_filtered =", total_reads_overall_fil))

# Print summary info
print(paste("lowest_total_reads =", lowest_total_reads))
print(paste("overall_lowest_rep_reads =", overall_lowest_rep_reads))

```

# comparing overlap between replicates for ASV on unfiterrd data
```{r}
# create a table of reads for each asv
metab_asv <- metab_fil %>%
  dplyr::group_by(asv_code, replicate) %>%
  summarise(reads = sum(reads))

# make PCR replicates heading and add read tally
metab_asv <- spread(metab_asv, key = replicate, value = reads)

# tally samples that have a detection in both PCR replicates
count_both_values <- sum(!is.na(metab_asv$rep1) & !is.na(metab_asv$rep2))

# calculate the total number of rows
total_asv <- nrow(metab_asv)

# calculate the proportion of ASV appearing in both PCR replicates
asv_percentage_overlap <- count_both_values / total_asv *100

print(paste("~/git/ten_site_metabarcoding/data_analysis/run_stats/asv_percentage_overlap_btn_PCR_replicates =",asv_percentage_overlap))
```

# comparing overlap between replicates for ASV on fitered data
```{r}
# create a table of reads for each asv
metab_asv <- metab_filt %>%
  dplyr::group_by(asv_code, replicate) %>%
  summarise(reads = sum(reads))

# make PCR replicates heading and add read tally
metab_asv <- spread(metab_asv, key = replicate, value = reads)

# tally samples that have a detection in both PCR replicates
count_both_values <- sum(!is.na(metab_asv$rep1) & !is.na(metab_asv$rep2))

# calculate the total number of rows
total_asv <- nrow(metab_asv)

# calculate the proportion of ASV appearing in both PCR replicates
asv_percentage_overlap <- count_both_values / total_asv *100


print(paste("~/git/ten_site_metabarcoding/data_analysis/run_stats/asv_percentage_overlap_btn_PCR_replicates =",asv_percentage_overlap))
```

# comparing overlap between replicates for species unfiltered
```{r}
# pull out species identifications only by subseting out species data with a <= 97% match to the DNA barcode library
metabar_fil_97 <- subset(metab_fil, max_p_identity >= 97)

# pull out data need for species/PCR replicate comparison and format
metabar_sp <- metabar_fil_97 %>%
  group_by(species, replicate)  %>%
 summarize(reads = sum(reads)) %>%
  ungroup() 
metabar_sp_rep <- spread(metabar_sp, key = replicate, value = reads) # make PCR replicates heading

# tally samples that have a detection in both PCR replicates
count_both_values <- sum(!is.na(metabar_sp_rep$rep1) & !is.na(metabar_sp_rep$rep2))

# calculate the total number of rows
total_rows <- nrow(metabar_sp_rep)

# calculate the proportion of ASV appearing in both PCR replicates
sp_percentage_overlap <- count_both_values / total_rows *100

print(paste("species_percentage_overlap_btn_PCR_replicates_unfiltered =",sp_percentage_overlap))
```

# comparing overlap between replicates for species filtered
```{r}
# pull out species identifications only by subseting out species data with a <= 97% match to the DNA barcode library
metabar_fil_97 <- subset(metab_filt, max_p_identity >= 97)

# pull out data need for species/PCR replicate comparison and format
metabar_sp <- metabar_fil_97 %>%
  group_by(species, replicate)  %>%
 summarize(reads = sum(reads)) %>%
  ungroup() 
metabar_sp_rep <- spread(metabar_sp, key = replicate, value = reads) # make PCR replicates heading

# tally samples that have a detection in both PCR replicates
count_both_values <- sum(!is.na(metabar_sp_rep$rep1) & !is.na(metabar_sp_rep$rep2))

# calculate the total number of rows
total_rows <- nrow(metabar_sp_rep)

# calculate the proportion of ASV appearing in both PCR replicates
sp_percentage_overlap <- count_both_values / total_rows *100


print(paste("species_percentage_overlap_btn_PCR_replicates_filtered =",sp_percentage_overlap))
```

# How many sequences and ASVs were assigned to species
```{r}
# total number of ASVs
num_asv <- length(unique(metab_filt$asv_code))

#short amplicon (BF1/BR1) ASV's 
short_asv <- metab_filt[metab_filt$amplicon == "short", ]
uni_short <- length(unique(short_asv$asv_code))
short_asv_reads <- sum(short_asv$reads)

#right amplicon (mICOIintF/dgHCO2198) ASV's 
right_asv <- metab_filt[metab_filt$amplicon == "right", ]
uni_right <- length(unique(right_asv$asv_code))
right_asv_reads <- sum(right_asv$reads)

# total number of ASVs with species identifications
metabar_97 <- subset(metab_filt, max_p_identity >= 97)
num_asv_sp <- length(unique(metabar_97$asv_code))

# calculate the percentage of ASVs with species ids
percentage_asv_id <- num_asv_sp / num_asv *100

# total number of high quality reads
total_reads <- sum(metab_filt$reads)

# total number of high quality reads with species identifications
sp_reads <- sum(metabar_97$reads)

# calculate the percentage of reads with species identifications
percentage_sp_ids <- sp_reads/ total_reads *100

# how many species/families
sp_count <- length(unique(metabar_97$species))
fam_count <- length(unique(metabar_97$family))

# print stats
print(paste("total_reads_used in_analysis =", total_reads))
print(paste("Total_no_of_ASVs =",num_asv))
print(paste("Total_no_of_ASVs_short amplicon_(B/R5)  =", uni_short))
print(paste("Total_no_of_reads_short amplicon_(B/R5)  =", short_asv_reads))
print(paste("Total_no_of_ASVs_right amplicon_(mICOIintF/dgHCO2198)  =", uni_right))
print(paste("Total_no_of_reads_right amplicon_(mICOIintF/dgHCO2198)  =", right_asv_reads))
print(paste("percentage_asv_id_to_species =", percentage_asv_id))
print(paste("percentage of reads with species identifications", percentage_sp_ids))
print(paste("no. of species = ", sp_count))
print(paste("no. of family = ", fam_count))
```
